/* geochron v0.1 (c) 2014 Jiangping He */$(window).load(function(){function y(a){g+=1;$("#tracknum").val((1E3+g).toString().slice(1));a=(new L.marker(a,{icon:u,riseOnHover:!0,className:"jhe-fissionTrack-"+v})).on("click",function(a){}).addTo(map);c[v]=a;v++}function z(a){l=a.latlng;n.setBounds([k,l])}function s(a){L.DomEvent.preventDefault(a);L.DomEvent.stopPropagation(a);map.off("click",A);map.on("click",w);p=0;L.DomUtil.get($("#ftc-btn-select")).css("background-color","#fff");L.DomUtil.get($("#ftc-btn-delete")).addClass("leaflet-disabled");
n.setBounds([[0,0],[0,0]])}function A(a){p++;if(1==p)k=a.latlng,n.setBounds([k,k]),n.addTo(map).bringToFront(),map.on("mousemove",z);else if(2==p){l=a.latlng;n.setBounds([k,l]);bounds=L.latLngBounds(k,l);map.off("mousemove",z);map._container.style.cursor="crosshair";j=0;for(i in c)latlon=c[i].getLatLng(),bounds.contains(latlon)&&(f[j]=i,c[i].setIcon(E),j++);0<f.length?L.DomUtil.get($("#ftc-btn-delete")).removeClass("leaflet-disabled"):(f=[],s(a),console.log("no delete acton. marker #: "+B(c)))}else if(3==
p){for(i=f.length-1;0<=i;i--)indx=f[i],c[indx].setIcon(u);f=[];s(a)}else alert("click event should not listened any more")}function w(a){var b=this;setTimeout(function(){var d=parseInt($(b).data("jhe_double"),10);if(0<d)return $(b).data("jhe_double",d-1),!1;L.DomEvent.preventDefault(a);L.DomEvent.stopPropagation(a);for(var c=!1,d=0;d<q.length;d++)if(!c){for(var e=[a.latlng.lat,a.latlng.lng],c=q[d],f=e[0],e=e[1],g=!1,k=0,h=c.length-1;k<c.length;h=k++){var m=c[k][0],l=c[k][1],n=c[h][0],h=c[h][1];l>
e!=h>e&&f<(n-m)*(e-l)/(h-l)+m&&(g=!g)}c=g}c&&y(a.latlng)},300)}function C(a){t[a].bringToFront();a=t[a]._image;for(var b=a.parentElement.children,d=null,d=b.length-1;0<=d&&"svg"!=b.item(d).tagName.toLowerCase();d--);null!==d&&$(b.item(d)).insertAfter($(a))}var e={},x,r,D=[[0,0],[1,1]],t=[],h=[.5,.5],p=0,k,l,v=0,g=0,c={},q=[],f=[],m=L.Icon.extend({options:{iconSize:[6,6],iconAnchor:[3,3],popupAnchor:[0,0]}}),u=new m({iconUrl:iconUrl_normal}),E=new m({iconUrl:iconUrl_selected}),n=L.rectangle([[0,0],
[0,0]],{className:"ftc-rect-select-area",color:"#ff0000",fillOpacity:0,stroke:!0,weight:2,fill:!1,clickable:!0}),B=function(a){var b=0,d;for(d in a)a.hasOwnProperty(d)&&b++;return b};map=L.map("map",{center:h,zoom:11,minZoom:9,maxZoom:14,scrollWheelZoom:!1});map.attributionControl.setPrefix("");map.setView(h,11);L.easyButton({homeView:{icon:"fa-arrows-alt",tipText:"fit images to window",action:function(){map.setView(h,11)}},undo:{icon:"fa-history",tipText:"undo",className_a:"leaflet-disabled",action:function(){/*alert("hello! undo")*/}},
redo:{icon:"fa-repeat",tipText:"redo",className_a:"leaflet-disabled",action:function(){/*alert("hello! redo")*/}},select:{icon:"fa-pencil-square-o",tipText:"click twice to draw a rectangle and select multiple markers",action:function(a){if("rgb(219, 219, 219)"!=L.DomUtil.get($("#ftc-btn-select")).css("background-color"))map.off("click",w),map._container.style.cursor="crosshair",L.DomUtil.get($("#ftc-btn-select")).css("background-color","#dbdbdb"),map.on("click",A);else{for(i=f.length-1;0<=i;i--)indx=
f[i],c[indx].setIcon(u);f=[];s(a)}}},"delete":{icon:"fa-trash-o",tipText:"delete selected fission track markers",className_a:"leaflet-disabled",action:function(a){if(!$.isEmptyObject(a.currentTarget)&&"ftc-btn-delete"==a.currentTarget.id&&0<f.length){for(i=f.length-1;0<=i;i--)indx=f[i],map.removeLayer(c[indx]),delete c[indx],g-=1;$("#tracknum").val((1E3+g).toString().slice(1));console.log("after delete, marker #: "+B(c));f=[]}s(a)}}},map,"topright");map.on("click",w).on("dblclick",function(a){$(this).data("jhe_double",
2)});$("#map").mousewheel(function(a,b){var d=parseInt($("#slider2").val(),10),d=d-b,d=d>r-1?r-1:0>d?0:d;$("#slider2").val(d,{set:!0});C(d);return!1});m=L.Control.extend({options:{position:"topleft"},onAdd:function(a){a=L.DomUtil.create("div","leaflet-bar leaflet-control slider2-container");a.setAttribute("style","margin-left: 14px;margin-top: 27px;");this.slider_div=L.DomUtil.create("div","leaflet-bar-slider2",a);this.slider_div.id="slider2";this.slider_div.setAttribute("style","height:120px");return a}});
map.addControl(new m);m=$("#slider2");$("#slider2").noUiSlider({start:0,orientation:"vertical",range:{min:0,max:1},serialization:{lower:[$.Link({target:"-tooltip-"})],format:{decimals:0}}});m.on("slide",function(){var a=parseInt($("#slider2").val(),10);C(a)});$.ajaxSetup({beforeSend:function(a,b){a.setRequestHeader("X-CSRFToken",atoken)}});$.ajax({url:get_grain_images_url,type:"POST",dataType:"json",success:function(a){if("reply"in a)alert(a.reply);else{e.proj_id=a.proj_id;e.sample_id=a.sample_id;
e.grain_num=a.grain_num;e.ft_type=a.ft_type;e.image_width=a.image_width;e.image_height=a.image_height;console.log(a.proj_id+", "+a.sample_id+", "+a.grain_num+", "+a.ft_type);var b=a.image_height/a.image_width;D[1]=[b,1];h=[b/2,.5];x=a.images;r=x.length;$("#slider2").noUiSlider({range:{min:0,max:r-1}},!0);for(b=0;b<r;b++)t[b]=(new L.imageOverlay(x[b],D)).addTo(map);t[0].bringToFront();if("num_markers"in a&&"marker_latlngs"in a)for(var d,b=0;b<a.num_markers;b++)d=a.marker_latlngs[b],y(d);q=a.rois;for(b=
0;b<q.length;b++)polygon_array=q[b],L.polygon(polygon_array,{color:"white",opacity:1,fill:!1,clickable:!0,className:"ftc-rect-select-area"}).on("click",function(a){L.DomEvent.preventDefault(a);L.DomEvent.stopPropagation(a)}).addTo(map);map.setView(h,11)}},error:function(a,b,d){console.log(a.status+": "+a.responseText)}});$("#tracknum-submit").click(function(){if(1==confirm("submit the result?")){e.track_num=g;latlngs=[];var a=0,b;for(b in c)latlng=c[b].getLatLng(),latlngs[a]=[latlng.lat,latlng.lng],
a++;e.marker_latlngs=latlngs;str=JSON.stringify({counting_res:e});$.ajax({url:updateTFNResult_url,type:"POST",dataType:"json",data:str,success:function(a){console.log("submitted: "+a.reply);e={};window.location.reload(!0)},error:function(a,b,c){console.log(a.status+": "+a.responseText)}})}else console.log("You pressed Cancel!")});$("#tracknum-save").click(function(){if(1==confirm("Keep the intermedia result to the server?")){latlngs=[];var a=0,b;for(b in c)latlng=c[b].getLatLng(),latlngs[a]=[latlng.lat,
latlng.lng],a++;res={proj_id:e.proj_id,sample_id:e.sample_id,grain_num:e.grain_num,ft_type:e.ft_type,image_width:e.image_width,image_height:e.image_height,num_markers:a,marker_latlngs:latlngs};str=JSON.stringify({intermedia_res:res});console.log("total markers: "+a);console.log(latlngs);console.log(str);$.ajax({url:saveWorkingGrain_url,type:"POST",dataType:"json",data:str,success:function(a){console.log("submitted: "+a.reply)},error:function(a,b,c){console.log(a.status+": "+a.responseText);alert("Failed to save your intermedia result, Please try again.")}})}});
$("#tracknum-restart").click(function(){if(1==confirm("Are you sure that you want to reset the counter for this grain?")){g=0;for(var a in c)map.removeLayer(c[a]);c={};$("#tracknum").val((1E3+g).toString().slice(1));map.setView(h,11)}})});
